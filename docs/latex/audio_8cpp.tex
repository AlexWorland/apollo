\doxysection{/\+Users/alexworland/auto\+Bitrate/apollo/src/audio.cpp File Reference}
\hypertarget{audio_8cpp}{}\label{audio_8cpp}\index{/Users/alexworland/autoBitrate/apollo/src/audio.cpp@{/Users/alexworland/autoBitrate/apollo/src/audio.cpp}}


Definitions for audio capture and encoding.  


{\ttfamily \#include $<$thread$>$}\newline
{\ttfamily \#include $<$opus/opus\+\_\+multistream.\+h$>$}\newline
{\ttfamily \#include "{}audio.\+h"{}}\newline
{\ttfamily \#include "{}config.\+h"{}}\newline
{\ttfamily \#include "{}globals.\+h"{}}\newline
{\ttfamily \#include "{}logging.\+h"{}}\newline
{\ttfamily \#include "{}platform/common.\+h"{}}\newline
{\ttfamily \#include "{}thread\+\_\+safe.\+h"{}}\newline
{\ttfamily \#include "{}utility.\+h"{}}\newline
\doxysubsubsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
using \mbox{\hyperlink{audio_8cpp_af39d5ad295c6d28230903e038743b5ad}{audio\+::opus\+\_\+t}} = util\+::safe\+\_\+ptr$<$Opus\+MSEncoder, opus\+\_\+multistream\+\_\+encoder\+\_\+destroy$>$
\begin{DoxyCompactList}\small\item\em Opus multistream encoder pointer type. \end{DoxyCompactList}\item 
using \mbox{\hyperlink{audio_8cpp_a0a57e0970af5d3541c0c544c6c7383d6}{audio\+::sample\+\_\+queue\+\_\+t}} = std\+::shared\+\_\+ptr$<$\mbox{\hyperlink{classsafe_1_1queue__t}{safe\+::queue\+\_\+t}}$<$std\+::vector$<$float$>$$>$$>$
\begin{DoxyCompactList}\small\item\em Audio sample queue type. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \mbox{\hyperlink{audio_8cpp_a27efaa55153d250e217418e0f1b71d3c}{audio\+::map\+\_\+stream}} (int channels, bool quality)
\begin{DoxyCompactList}\small\item\em Map channel count and quality to stream configuration index. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{audio_8cpp_a953a9689dca799f13a7d3ebf2d3a9760}{audio\+::encode\+Thread}} (\mbox{\hyperlink{audio_8cpp_a0a57e0970af5d3541c0c544c6c7383d6}{sample\+\_\+queue\+\_\+t}} samples, \mbox{\hyperlink{structaudio_1_1config__t}{config\+\_\+t}} config, void \texorpdfstring{$\ast$}{*}channel\+\_\+data)
\begin{DoxyCompactList}\small\item\em Audio encoding thread function. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{audio_8cpp_a50f4f1627a2b1c7ae2021dd0dbf21b03}{audio\+::capture}} (safe\+::mail\+\_\+t \mbox{\hyperlink{namespacemail}{mail}}, \mbox{\hyperlink{structaudio_1_1config__t}{config\+\_\+t}} config, void \texorpdfstring{$\ast$}{*}channel\+\_\+data)
\begin{DoxyCompactList}\small\item\em Capture audio from the system and encode it. \end{DoxyCompactList}\item 
\mbox{\hyperlink{audio_8h_aa090183dda3ff69e10765b34e048a6a9}{audio\+\_\+ctx\+\_\+ref\+\_\+t}} \mbox{\hyperlink{audio_8cpp_acf6045021b53fd7c6583fe9ac2740fbe}{audio\+::get\+\_\+audio\+\_\+ctx\+\_\+ref}} ()
\begin{DoxyCompactList}\small\item\em Get the reference to the audio context. \end{DoxyCompactList}\item 
bool \mbox{\hyperlink{audio_8cpp_a7ca978d7523c30309defd31a66d1654c}{audio\+::is\+\_\+audio\+\_\+ctx\+\_\+sink\+\_\+available}} (const \mbox{\hyperlink{structaudio_1_1audio__ctx__t}{audio\+\_\+ctx\+\_\+t}} \&ctx)
\begin{DoxyCompactList}\small\item\em Check if the audio sink held by audio context is available. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
constexpr auto \mbox{\hyperlink{audio_8cpp_a228cc62846b0966cb859f109c8db432d}{audio\+::\+SAMPLE\+\_\+\+RATE}} = 48000
\begin{DoxyCompactList}\small\item\em Audio sample rate in Hz. \end{DoxyCompactList}\item 
\Hypertarget{audio_8cpp_a5a46ad6f50b6032175ee1f935360622d}\label{audio_8cpp_a5a46ad6f50b6032175ee1f935360622d} 
\mbox{\hyperlink{structaudio_1_1opus__stream__config__t}{opus\+\_\+stream\+\_\+config\+\_\+t}} {\bfseries audio\+::stream\+\_\+configs} \mbox{[}\mbox{\hyperlink{audio_8h_ac92552a5fdc9c1f75dfca4542c7f3cd9aea5748c50c878b9d1f90504c4d377a3d}{MAX\+\_\+\+STREAM\+\_\+\+CONFIG}}\mbox{]}
\begin{DoxyCompactList}\small\item\em Predefined stream configurations. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Definitions for audio capture and encoding. 



\label{doc-typedef-members}
\Hypertarget{audio_8cpp_doc-typedef-members}
\doxysubsection{Typedef Documentation}
\Hypertarget{audio_8cpp_af39d5ad295c6d28230903e038743b5ad}\index{audio.cpp@{audio.cpp}!opus\_t@{opus\_t}}
\index{opus\_t@{opus\_t}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{opus\_t}{opus\_t}}
{\footnotesize\ttfamily \label{audio_8cpp_af39d5ad295c6d28230903e038743b5ad} 
using \mbox{\hyperlink{audio_8cpp_af39d5ad295c6d28230903e038743b5ad}{audio\+::opus\+\_\+t}} = util\+::safe\+\_\+ptr$<$Opus\+MSEncoder, opus\+\_\+multistream\+\_\+encoder\+\_\+destroy$>$}



Opus multistream encoder pointer type. 

Smart pointer managing Opus\+MSEncoder lifecycle with automatic cleanup. \Hypertarget{audio_8cpp_a0a57e0970af5d3541c0c544c6c7383d6}\index{audio.cpp@{audio.cpp}!sample\_queue\_t@{sample\_queue\_t}}
\index{sample\_queue\_t@{sample\_queue\_t}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{sample\_queue\_t}{sample\_queue\_t}}
{\footnotesize\ttfamily \label{audio_8cpp_a0a57e0970af5d3541c0c544c6c7383d6} 
using \mbox{\hyperlink{audio_8cpp_a0a57e0970af5d3541c0c544c6c7383d6}{audio\+::sample\+\_\+queue\+\_\+t}} = std\+::shared\+\_\+ptr$<$\mbox{\hyperlink{classsafe_1_1queue__t}{safe\+::queue\+\_\+t}}$<$std\+::vector$<$float$>$$>$$>$}



Audio sample queue type. 

Thread-\/safe queue for passing audio samples between capture and encoding threads. 

\label{doc-func-members}
\Hypertarget{audio_8cpp_doc-func-members}
\doxysubsection{Function Documentation}
\Hypertarget{audio_8cpp_a50f4f1627a2b1c7ae2021dd0dbf21b03}\index{audio.cpp@{audio.cpp}!capture@{capture}}
\index{capture@{capture}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{capture()}{capture()}}
{\footnotesize\ttfamily \label{audio_8cpp_a50f4f1627a2b1c7ae2021dd0dbf21b03} 
void audio\+::capture (\begin{DoxyParamCaption}\item[{safe\+::mail\+\_\+t}]{mail}{, }\item[{\mbox{\hyperlink{structaudio_1_1config__t}{config\+\_\+t}}}]{config}{, }\item[{void \texorpdfstring{$\ast$}{*}}]{channel\+\_\+data}{}\end{DoxyParamCaption})}



Capture audio from the system and encode it. 

Captures audio from the selected audio sink, encodes it using Opus, and sends encoded packets through the mail system.


\begin{DoxyParams}{Parameters}
{\em mail} & Mail system for communication and packet delivery. \\
\hline
{\em config} & Audio configuration including channels, quality, and flags. \\
\hline
{\em channel\+\_\+data} & Channel-\/specific data pointer to include with packets. \\
\hline
\end{DoxyParams}
\Hypertarget{audio_8cpp_a953a9689dca799f13a7d3ebf2d3a9760}\index{audio.cpp@{audio.cpp}!encodeThread@{encodeThread}}
\index{encodeThread@{encodeThread}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{encodeThread()}{encodeThread()}}
{\footnotesize\ttfamily \label{audio_8cpp_a953a9689dca799f13a7d3ebf2d3a9760} 
void audio\+::encode\+Thread (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{audio_8cpp_a0a57e0970af5d3541c0c544c6c7383d6}{sample\+\_\+queue\+\_\+t}}}]{samples}{, }\item[{\mbox{\hyperlink{structaudio_1_1config__t}{config\+\_\+t}}}]{config}{, }\item[{void \texorpdfstring{$\ast$}{*}}]{channel\+\_\+data}{}\end{DoxyParamCaption})}



Audio encoding thread function. 

Encodes audio samples from the queue using Opus multistream encoder and sends encoded packets through the mail system.


\begin{DoxyParams}{Parameters}
{\em samples} & Thread-\/safe queue of audio sample buffers to encode. \\
\hline
{\em config} & Audio configuration for encoding parameters. \\
\hline
{\em channel\+\_\+data} & Channel-\/specific data pointer to include with packets. \\
\hline
\end{DoxyParams}
\Hypertarget{audio_8cpp_acf6045021b53fd7c6583fe9ac2740fbe}\index{audio.cpp@{audio.cpp}!get\_audio\_ctx\_ref@{get\_audio\_ctx\_ref}}
\index{get\_audio\_ctx\_ref@{get\_audio\_ctx\_ref}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{get\_audio\_ctx\_ref()}{get\_audio\_ctx\_ref()}}
{\footnotesize\ttfamily \label{audio_8cpp_acf6045021b53fd7c6583fe9ac2740fbe} 
audio\+\_\+ctx\+\_\+ref\+\_\+t audio\+::get\+\_\+audio\+\_\+ctx\+\_\+ref (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})}



Get the reference to the audio context. 

\begin{DoxyReturn}{Returns}
A shared pointer reference to audio context. 
\end{DoxyReturn}
\begin{DoxyNote}{Note}
Aside from the configuration purposes, it can be used to extend the audio sink lifetime to capture sink earlier and restore it later.
\end{DoxyNote}
@examples audio\+\_\+ctx\+\_\+ref\+\_\+t audio = get\+\_\+audio\+\_\+ctx\+\_\+ref() @examples\+\_\+end \Hypertarget{audio_8cpp_a7ca978d7523c30309defd31a66d1654c}\index{audio.cpp@{audio.cpp}!is\_audio\_ctx\_sink\_available@{is\_audio\_ctx\_sink\_available}}
\index{is\_audio\_ctx\_sink\_available@{is\_audio\_ctx\_sink\_available}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{is\_audio\_ctx\_sink\_available()}{is\_audio\_ctx\_sink\_available()}}
{\footnotesize\ttfamily \label{audio_8cpp_a7ca978d7523c30309defd31a66d1654c} 
bool audio\+::is\+\_\+audio\+\_\+ctx\+\_\+sink\+\_\+available (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{structaudio_1_1audio__ctx__t}{audio\+\_\+ctx\+\_\+t}} \&}]{ctx}{}\end{DoxyParamCaption})}



Check if the audio sink held by audio context is available. 

\begin{DoxyReturn}{Returns}
True if available (and can probably be restored), false otherwise. 
\end{DoxyReturn}
\begin{DoxyNote}{Note}
Useful for delaying the release of audio context shared pointer (which tries to restore original sink).
\end{DoxyNote}
@examples audio\+\_\+ctx\+\_\+ref\+\_\+t audio = get\+\_\+audio\+\_\+ctx\+\_\+ref() if (audio.\+get()) \{ return is\+\_\+audio\+\_\+ctx\+\_\+sink\+\_\+available(\texorpdfstring{$\ast$}{*}audio.get()); \} return false; @examples\+\_\+end \Hypertarget{audio_8cpp_a27efaa55153d250e217418e0f1b71d3c}\index{audio.cpp@{audio.cpp}!map\_stream@{map\_stream}}
\index{map\_stream@{map\_stream}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{map\_stream()}{map\_stream()}}
{\footnotesize\ttfamily \label{audio_8cpp_a27efaa55153d250e217418e0f1b71d3c} 
int audio\+::map\+\_\+stream (\begin{DoxyParamCaption}\item[{int}]{channels}{, }\item[{bool}]{quality}{}\end{DoxyParamCaption})}



Map channel count and quality to stream configuration index. 

Determines which predefined stream configuration to use based on the number of channels and quality setting.


\begin{DoxyParams}{Parameters}
{\em channels} & Number of audio channels (2, 6, or 8). \\
\hline
{\em quality} & Whether to use high quality configuration. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Index into stream\+\_\+configs array. 
\end{DoxyReturn}


\label{doc-var-members}
\Hypertarget{audio_8cpp_doc-var-members}
\doxysubsection{Variable Documentation}
\Hypertarget{audio_8cpp_a228cc62846b0966cb859f109c8db432d}\index{audio.cpp@{audio.cpp}!SAMPLE\_RATE@{SAMPLE\_RATE}}
\index{SAMPLE\_RATE@{SAMPLE\_RATE}!audio.cpp@{audio.cpp}}
\doxysubsubsection{\texorpdfstring{SAMPLE\_RATE}{SAMPLE\_RATE}}
{\footnotesize\ttfamily \label{audio_8cpp_a228cc62846b0966cb859f109c8db432d} 
auto audio\+::\+SAMPLE\+\_\+\+RATE = 48000\hspace{0.3cm}{\ttfamily [constexpr]}}



Audio sample rate in Hz. 

Standard sample rate used for all audio encoding (48 k\+Hz). 